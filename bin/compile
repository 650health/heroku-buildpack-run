#!/usr/bin/env bash
#
# This buildpack can be used for executing custom commands on the build dyno.
#
# A user-specified file (specified by the config var BUILDPACK_RUN, or, by
# default, ./buldpack-run.sh) is sourced on the build dyno at compile time.
#
# Note: sourcing means that the commands in the file are executed in the
#       current shell.
#
# The working directory is the root directory of the app.
#
# ---
#
# The 'compile' script is executed by the slug compiler with three arguments:
#   $1: build_dir, location of your app directory on the build dyno
#   $2: cache_dir, directory on the build dyno that persists between builds
#   $3: env_dir, directory holding all the app's config vars as files
#
# More information here: https://devcenter.heroku.com/articles/buildpack-api
#
# Daniel Weibel <danielmweibel@gmail.com> March 2015 - July 2016
#------------------------------------------------------------------------------#

# Rename variables for easier access in the user-specified file to source
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

cd "$BUILD_DIR"

# Test if the config var BUILDPACK_RUN is set. If yes, take on its content as
# the file to source, if not, take on ./buildpack-run.sh as the file to source.
if [[ -f "$ENV_DIR/BUILDPACK_RUN" ]]; then
  buildpack_run=$(cat "$ENV_DIR/BUILDPACK_RUN")
elif [[ -f ./buildpack-run.sh ]]; then
  buildpack_run=./buildpack-run.sh
else
  echo "Can't apply heroku-buildpack-run: you have to either set the"
  echo "config var BUILDPACK_RUN, or add the file buildpack-run.sh"
  echo "in the root directory of your app."
  exit 1
fi

echo "Sourcing $buildpack_run" | sed 's/^/-----> /'

# Source the specified file. Note: the entire build can be aborted by the
# command 'exit 1' in the sourced file.
source "$buildpack_run"
