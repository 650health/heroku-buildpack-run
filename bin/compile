#!/usr/bin/env bash
#
# This buildpack can be used for executing custom commands on the build dyno.
#
# A user-specified file (specified by the config var BUILDPACK_RUN, or, by
# default, ./buldpack-run.sh) is sourced on the build dyno at compile time.
#
# Note: sourcing means that the commands in the file are executed in the
#       current shell.
#
# The working directory is the root directory of the app.
#
# ---
#
# The 'compile' script is executed by the slug compiler with three arguments:
#   $1: build_dir, location of your app directory on the build dyno
#   $2: cache_dir, directory on the build dyno that persists between builds
#   $3: env_dir, directory holding all the app's config vars as files
#
# More information here: https://devcenter.heroku.com/articles/buildpack-api
#
# Daniel Weibel <danielmweibel@gmail.com> March 2015 - February 2017
#------------------------------------------------------------------------------#

# Indent text by seven spaces
i() {
  sed 's/^/       /'
}

# Rename variables for easier access in the user-specified file to source
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

cd "$BUILD_DIR"

# If config var BUILDPACK_RUN exists, take its content as the file(s) to source
if [[ -f "$ENV_DIR/BUILDPACK_RUN" ]]; then
  buildpack_run=$(cat "$ENV_DIR/BUILDPACK_RUN")
# Otherwise, if buildpack-run.sh exists, take it as the file to source
elif [[ -f ./buildpack-run.sh ]]; then
  buildpack_run=./buildpack-run.sh
# If neither exists, abort the build
else
  echo "Error: can't apply the buildpack. You have to either create" | i
  echo "the file buildpack-run.sh in the root directory of your app" | i
  echo "or set the config var BUILDPACK_RUN to any other file you" | i
  echo "want to source."
  echo
  exit 1
fi

echo "Sourcing $buildpack_run" | sed 's/^/-----> /'

# Source the specified file. Note: the entire build can be aborted by the
# command 'exit 1' in the sourced file.
source $buildpack_run
